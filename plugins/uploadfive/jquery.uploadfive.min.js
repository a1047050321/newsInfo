;(function(d,g,b){var h=g.document,i=g.navigator,j=g.location;var c={NOT_ALLOW_SELECT:"不合法的文件将不被添加到队列中！",NOT_ALLOW_UPLOAD:"文件 ${fileName} 类型不合法，不允许上传！",REPLACE_FIlE_IN_QUEUE:"文件 ${fileName} 已存在队列中，是否继续添加？",};var k={addEvent:function(m,o,n){m=m||h;if(h.addEventListener){m.addEventListener(o,n,false)}else{m.attachEvent("on"+o,n)}},removeEvent:function(m,o,n){m=m||h;if(h.removeEventListener){m.removeEventListener(o,n,false)}else{m.detachEvent("on"+o,n)}}};var a={init:function(m){return this.each(function(){var s=this,u=d(this),q=u.parent();var t=u.clone();var v={id:u.attr("id"),};var o=d.extend({auto:true,uploader:"",method:"POST",dataType:false,formData:{},fileObjName:"Filedata",multi:false,fileTypeExts:"*.*",queueID:false,buttonText:"选择文件",buttonClass:"uploadfive-button",buttonCursor:"pointer",removeCancelled:true,removeCompleted:true,removeTimeout:3,progressData:"percentage",itemTemplate:false,},m,v);var n={file_post_name:o.fileObjName,file_allow_ext:o.fileTypeExts,request_method:o.method,request_url:o.uploader,settings:o,method_upload_handler:a.upload,method_cancel_handler:a.cancel,file_queued_handler:l.onSelect,object_init_handler:o.onInit||b,upload_cancel_handler:l.onCancel,upload_error_handler:l.onUploadError,upload_progress_handler:l.onUploadProgress,upload_start_handler:l.onUploadStart,upload_success_handler:l.onUploadSuccess,};g["uploadfive_"+o.id]=d.extend({},n);var p=g["uploadfive_"+o.id];var x=f.initButtonText.call(p);u=d("#"+o.id);u.data("uploadfive",p);if(!o.queueID){var r=d("<div />",{"id":o.id+"-queue","class":"uploadfive-queue"});u.after(r);p.settings.queueID=o.id+"-queue";p.settings.defaultQueue=true}p.queueData=f.getDefaultQueueData();p.original=t;p.queue=r||d("#"+o.queueID);d("#"+o.id+" #"+x).bind("change",function(){var C=this.files,y=C.length;var B=false;for(var A=0;A<y;A++){var z=C[A];if(e.allowUpload(z,o.fileTypeExts)){if(e.inQueue(z,p.queueData.files)){if(!confirm(c.REPLACE_FIlE_IN_QUEUE.replace("${fileName}",z.name))){continue}}if(!B){p.queueData.filesSelected++;B=true}p.file_queued_handler.call(p,z)}else{alert(c.NOT_ALLOW_UPLOAD.replace("${fileName}",z.name));continue}}d(this).val("");if(o.auto){p.method_upload_handler.call(u)}});var w=p.object_init_handler;if(w&&typeof w==="function"){w.call(u,p)}})},cancel:function(m,n){var o=arguments;return this.each(function(){var w=d(this),r=w.data("uploadfive"),q=r.settings;var t=r.queue;var u=o[0];if(u){if(u=="*"){var p=r.queueData.files,y=r.queueData.filesLength;for(var s in p){if(p.hasOwnProperty(s)){f.cancelUpload.call(r,s,function(){t.find("#"+s+" .cancel").remove();if(q.removeCancelled){t.find("#"+s).fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}})}}f.clearQueue.call(r,function(){if(e.isFunction(q.onClearQueue)){q.onClearQueue.call(w,y)}})}else{f.cancelUpload.call(r,u,function(){t.find("#"+u+" .cancel").remove();if(q.removeCancelled){t.find("#"+u).fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}})}}else{var x=t.children().eq(0);if(x>0){return false}var v=x.attr("id");f.cancelUpload.call(r,v,function(){x.find(".cancel").remove();if(q.removeCancelled){x.fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}})}})},settings:function(n,o){var m=arguments;this.each(function(){var r=d(this),p=r.data("uploadfive"),q=p.settings;if(m.length===1){return q[n]}else{switch(n){case"auto":o=inArray(o,[true,false])>-1?o:true;break;case"uploader":p.request_url=o;break;case"method":p.request_method=o;break;case"fileObjName":p.file_post_name=o;break;case"formData":o=d.extend(q.formData,o);break;case"multi":o=inArray(o,[true,false])>-1?o:false;break;case"fileTypeExts":p.file_allow_ext=o;break;case"buttonText":d("#"+q.id+" span").html(o);break;case"buttonClass":d("#"+q.id).removeClass(q.buttonClass);d("#"+q.id).addClass(o);break;case"buttonCursor":d("#"+q.id).css("cursor",o);break;case"removeCancelled":o=inArray(o,[true,false])>-1?o:true;break;case"removeCompleted":o=inArray(o,[true,false])>-1?o:true;break;case"progressData":o=inArray(o,["percentage","speed"])>-1?o:"percentage";break}q[n]=o}})},upload:function(m){var n=arguments;return this.each(function(){var s=d(this),p=s.data("uploadfive"),q=p.settings,o=p.queueData;if(o.filesLength<=0){return false}var r=p.queue;if(o.uploadQueue.length>0){f.loadUploadQueue.apply(p,n)}else{f.loadUploadQueue.apply(p,n);f.startUpload.call(p,o.uploadQueue.shift())}})}};var l={onCancel:function(o){var n=this,p=this.settings,m=this.queueData,q=d("#"+p.id);if(e.isFunction(p.onCancel)){p.onCancel.call(q,o)}f.uploadComplete.call(n,o)},onSelect:function(o){var p=this.settings,u=this.queueData,v=d("#"+p.id);var t="FDUpload_"+p.id+"_"+(u.filesSelected-1)+"_"+u.filesLength;var s=e.getFileInfos(o);var w=d.extend({},o,{id:t,index:u.filesLength,filestatus:-1,type:s.type,original:o});u.filesLength++;u.queueSize+=o.size;var r=o.name;var q={"fileID":t,"instanceID":p.id,"fileFullName":r,"fileName":r.length>20?(r.substring(0,20)+"..."):r,"fileSize":s.size,"fileType":s.type};if(!p.itemTemplate){p.itemTemplate='<div id="${fileID}" class="uploadfive-queue-item">                    <div class="cancel">                        <a title="取消" href="javascript:$(\'#${instanceID}\').uploadfive(\'cancel\', \'${fileID}\')">X</a>                    </div>                    <div class="information">                        <span title="${fileFullName}" class="fileName">${fileName} (${fileSize})</span><span class="data"></span>                        <div class="uploadfive-progress">                            <div class="uploadfive-progress-bar"><!--Progress Bar--></div>                        </div>                    </div>                </div>'}var x=p.itemTemplate;for(var m in q){x=x.replace(new RegExp("\\$\\{"+m+"\\}","g"),q[m])}this.queue.append(x);u.files[t]=w;if(e.isFunction(p.onSelect)){p.onSelect.call(v,w)}},onUploadError:function(p){var n=this,q=this.settings,m=this.queueData,r=d("#"+q.id);f.setFileStatus(p,0);m.uploadsErrored++;var o=this.queue.find("#"+p.id);o.find(".data").html(" - Errored");o.find(".uploadfive-progress-bar").css("width","1px");o.find(".cancel").remove();if(q.removeCompleted){o.fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}if(e.isFunction(q.onUploadError)){q.onUploadError.call(r,p)}f.uploadComplete.call(n,p)},onUploadProgress:function(o,y,s){var q=this,p=this.settings,v=this.queueData,w=d("#"+p.id);if(f.getFileStatus(o)!=2){return false}var m=(new Date()).getTime(),t=m-this.timer;if(t>500){this.timer=m}var r=y-this.bytesLoaded;v.queueBytesUploaded+=y;this.bytesLoaded=y;var B=Math.round(y/s*100);var A="KB/s";var n=(r*1024)/(t*1000);n=Math.floor(n*10)/10;if(v.averageSpeed>0){v.averageSpeed=Math.floor((v.averageSpeed+n)/2)}else{v.averageSpeed=n}if(n>1000){var u=Math.floor(n/1000);v.averageSpeed=u;A="MB/s"}var x={"percentage":B+"%","speed":v.averageSpeed+A};var z=this.queue.find("#"+o.id);z.find(".data").html(" - "+(x[p.processData]||(B+"%")));z.find(".uploadfive-progress-bar").css("width",(B+"%"));if(e.isFunction(p.onUploadProgress)){p.onUploadProgress.call(w,o,y,s,v.queueBytesUploaded,v.queueSize)}},onUploadStart:function(n){var o=this,q=this.settings,m=this.queueData,r=d("#"+q.id);this.timer=(new Date()).getTime();this.bytesLoaded=0;var p=m.files[n];f.setFileStatus(p,2);if(e.isFunction(q.onUploadStart)){q.onUploadStart.call(r,p)}},onUploadSuccess:function(p,r){var n=this,q=this.settings,m=this.queueData,s=d("#"+q.id);f.setFileStatus(p,1);m.uploadsSuccessful++;m.queueBytesUploaded+=p.size;var o=this.queue.find("#"+p.id);o.find(".data").html(" - Completed");o.find(".cancel").remove();if(q.removeCompleted){o.fadeOut(q.removeTimeout*1000,function(){d(this).remove()})}if(e.isFunction(q.onUploadSuccess)){q.onUploadSuccess.call(s,p,r)}f.uploadComplete.call(n,p)}};var f={initButtonText:function(){var p=this.settings;var n=p.fileTypeExts=="*.*"?"":(' accept="'+p.fileTypeExts.replace(/\*\./ig,".")+'"');var o="uploadfive_"+p.id;var m='<div class="'+p.buttonClass+'" style="cursor:'+p.buttonCursor+';" id="'+p.id+'">'+"<span>"+p.buttonText+"</span>"+'<input type="file"'+n+' id="'+o+'" name="'+o+'" '+(p.multi?'multiple="multiple"':"")+" />"+"</div>";d("#"+p.id).replaceWith(m);return o},startUpload:function(n){var o=this,s=this.settings,m=o.queueData;o.upload_start_handler.call(this,n);var r=m.files[n],t=m.files[n];var q=new FormData();q.append(s.fileObjName,r.original);for(var p in s.formData){if(s.formData.hasOwnProperty(p)){q.append(p,s.formData[p])}}d.ajax({url:o.request_url,type:o.request_method,data:q,contentType:false,processData:false,dataType:s.dataType,xhr:function(){var u=d.ajaxSettings.xhr();m.xhrs[n]=u;k.addEvent(u.upload,"progress",function(y){var w=y||g.event;var v=w.loaded||0,x=w.total||t.size;o.upload_progress_handler.call(o,t,v,x)});k.addEvent(u,"abort",function(w){var v=w||g.event;o.upload_cancel_handler.call(o,t)});return u},success:function(u){o.upload_success_handler.call(o,t,u)},error:function(){if(f.getFileStatus(t)==2){o.upload_error_handler.call(o,t)}}})},cancelUpload:function(r,t){var o=this,n=this.settings,s=this.queueData,m=s.files[r];if(m===b){return false}if(e.inArray(f.getFileStatus(m),[-1,2])>-1){o.queue.find("#"+r+" .data").html(" - Cancelled");o.queue.find("#"+r+" .uploadfive-progress-bar").css("width","1px");f.setFileStatus(m,3);s.uploadsCancelled++;var q=e.inArray(r,s.uploadQueue);if(q>-1){var p=s.uploadQueue;s.uploadQueue=[].concat(p.slice(0,q),p.slice((q+1),p.length))}var u=s.xhrs[r];if(u){u.abort()}else{o.upload_cancel_handler.call(this,m)}}if(e.isFunction(t)){t()}},clearQueue:function(o){var m=this,n=this.settings;m.queueData=f.getDefaultQueueData();if(n.removeCancelled){m.queue.find(".uploadfive-queue-item").fadeOut(n.removeTimeout*1000,function(){d(this).remove()})}m.timer=0;delete m.timer;m.bytesLoaded=0;delete m.bytesLoaded;if(e.isFunction(o)){o()}},getDefaultQueueData:function(){var m={files:{},filesSelected:0,filesLength:0,averageSpeed:0,queueBytesUploaded:0,queueSize:0,uploadSize:0,uploadQueue:[],uploadsSuccessful:0,uploadsErrored:0,uploadsCancelled:0,xhrs:{},};return m},loadUploadQueue:function(r){var o=this,t=o.queueData;var u=[],s=0;r=r||"*";var m=t.files;var n=null;if(r&&typeof r==="string"){if(r=="*"){for(var p in m){n=m[p];if(n.filestatus==-1){s+=n.size;u.push(n.id)}}}else{n=m[r];if(n&&n.filestatus==-1){s+=n.size;u.push(r)}}}else{var q=r;for(var p=0;p<q;p++){n=m[r[p]];if(n&&n.filestatus==-1){s+=n.size;u.push(n.id)}}}t.uploadSize=s;t.uploadQueue=u;return u},getFileStatus:function(m){return m.filestatus},setFileStatus:function(n,m){n.filestatus=m},uploadComplete:function(o){var n=this,p=this.settings,m=this.queueData,q=d("#"+p.id);if(e.isFunction(p.onUploadComplete)){p.onUploadComplete.call(q,o)}if(m.uploadQueue.length>0){f.startUpload.call(n,m.uploadQueue.shift())}if(m.filesLength==(m.uploadsSuccessful+m.uploadsErrored+m.uploadsCancelled)){if(e.isFunction(p.onQueueComplete)){p.onQueueComplete.call(q,{"uploadsSuccessful":m.uploadsSuccessful,"uploadsErrored":m.uploadsErrored,"uploadsCancelled":m.uploadsCancelled})}if(p.removeCompleted){f.clearQueue.call(this)}else{d.extend(m,{filesLength:0,averageSpeed:0,queueBytesUploaded:0,queueSize:0,uploadSize:0,uploadQueue:[],uploadsSuccessful:0,uploadsErrored:0,uploadsCancelled:0,})}}}};var e={allowUpload:function(p,m){var o=m.split(",");for(var n=o.length-1;n>-1;n--){o[n]="("+d.trim(o[n].replace(".","\\.").replace("*",".*"))+"$)"}o=o.join("|");return(new RegExp(o,"ig")).test(p.name)},cleckQueueExts:function(p,n){var m=p.length;for(var o=p.length;o>-1;o--){if(!this.allowUpload(p,n)){return true}}return false},computeFileSize:function(m,n){n=n||2;if(m>1024*1024*1024*1024){m=m/(1024*1024*1024*1024);m=(""+m).indexOf(".")>-1?m.toFixed(n):m;return m+"TB"}else{if(m>1024*1024*1024){m=m/(1024*1024*1024);m=(""+m).indexOf(".")>-1?m.toFixed(n):m;return m+"GB"}else{if(m>1024*1024){m=m/(1024*1024);m=(""+m).indexOf(".")>-1?m.toFixed(n):m;return m+"MB"}else{if(m>1024){return(Math.round(m/1024))+"KB"}else{return Math.round(m)+"Byte"}}}}},getFileInfos:function(m){var n=m.name.lastIndexOf(".");if(n>-1){return{name:m.name.substring(0,n)||"未命名文件",type:m.name.substring(n)||"未知格式",size:this.computeFileSize(m.size)}}return{}},inArray:function(o,m){if(d.inArray){return d.inArray(o,m)}else{for(var n=m.length-1;n>-1;n--){if(m[n]==o){return n}}return -1}},isFunction:function(m){if(m&&typeof m==="function"){return true}return false},inQueue:function(n,o){for(var m in o){if(o.hasOwnProperty(m)){if(n.name==o[m].name&&o[m].filestatus==-1&&n.size==o[m].size){return o[m].id}}}return false}};d.fn.uploadfive=function(m){if(a[m]){return a[m].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof m==="object"||!m){return a.init.apply(this,arguments)}else{d.error("方法 "+m+" 在$.uploadfive中未定义！")}}}}(jQuery,window,undefined));